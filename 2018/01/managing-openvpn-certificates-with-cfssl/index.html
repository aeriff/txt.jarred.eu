<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Managing OpenVPN certificates with cfssl | txt.jarred.eu</title>
    <link rel="stylesheet" href="/static/tachyons.min.css">
    <meta name="generator" content="Nanoc 4.8.19">
  </head>
  <body class="w-100 sans-serif bg-white">
    <main>
      <header class="bg-gold sans-serif">
  <div class="mw9 center pa4 pt5-ns ph7-l">
    <h3 class="f2 f1-m f-subheadline-l measure-narrow lh-title mt0 mb3">
      <span class="bg-black lh-copy pa1 tracked-tight">
        <a class="link gold hover-white" href="/">txt.jarred.eu</a>
      </span>
    </h3>
    <nav class="f6 fw6 ttu tracked-tight black-80">
      <a class="link hover-bg-white black dib mr3" href="/about/">About</a>
    </nav>
  </div>
</header>

      <article>
        <div class="near-black pa4 ph7-l mw9-l center">
          <div class="pt1 pt2-ns">
            
<div>
  <h1 class="measure ma0 pa0 f4 f3-m f2-l">Managing OpenVPN certificates with cfssl</h3>
  <time class="f6 mb2 dib ttu tracked mid-gray"><small>2018-01-08</small></span>
</div>
  
<p class="measure copy lh-copy">
I run an instance of OpenVPN for use when I'm out and about on public WiFi, eg. at cafes or airports. Until recently, it ran on a small VPS with Arch Linux x86. Given the deprecation of the x86 architecture by Arch and that I don't run anything of much value there, I decided to give <a href="http://voidlinux.eu" class="link black underline">Void Linux</a> a spin (mostly because I really like <a href="http://smarden.org/runit/" class="link black underline">runit</a>, which is the init system in Void). As Void uses libressl which is <a href="https://github.com/OpenVPN/easy-rsa/issues/76" class="link black underline">known to not play nicely with easy-rsa</a>, I decided to try managing the CA and client certificates with <a href="https://github.com/cloudflare/cfssl" class="link black underline">cfssl</a>.
</p>

<p class="measure copy lh-copy">
As a leading caveat: Proper security around key handling is an exercise left to the reader, this is merely a guide to be able to replace the basic functionality of <code class="bg-near-white pa1">easy-rsa</code> with <code class="bg-near-white pa1">cfssl</code>. Operations other than issuing keys are also left up to the reader.
</p>

<p class="measure copy lh-copy">
As cfssl expects JSON files for configuration, we'll take care of that first (modify as needed, eg. common names and country/organisation values):
</p>


<pre class="measure copy lh-copy overflow-auto code pa2 bg-near-white black">
mkdir -p vpn/{config,certs}

<span class="black-50"># vpn/config/csr.json</span>
{
    "cn": "My VPN CA",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "DE",
            "O": "OpenVPN"
        }
    ]
}

<span class="black-50"># vpn/config/ca.json</span>
{
    "signing": {
        "profiles": {
            "server": {
                "expiry": "43800h",
                "usages": [
                    "digital signature",
                    "key encipherment",
                    "server auth"
                ]
            },
            "client": {
                "expiry": "43800h",
                "usages": [
                    "signing",
                    "client auth"
                ]
            }
        }
    }
}
</pre>

<p class="measure copy lh-copy">
You'll notice we're using TLS key usage extensions as outlined in <a href="https://www.ietf.org/rfc/rfc3280.txt" class="link black underline">RFC3280</a> to take advantage of things like the OpenVPN client directive <code class="pa1 bg-near-white">remote-cert-tls server</code>.
</p>

<p class="measure copy lh-copy">
Now we can initialise the CA and generate certificates for the server:
</p>

<pre class="measure copy lh-copy overflow-auto code pa2 bg-near-white black">
cfssl genkey -initca vpn/config/csr.json | \
  cfssljson -bare vpn/certs/ca

cfssl gencert -ca vpn/certs/ca.pem \
  -ca-key vpn/certs/ca-key.pem \
  -config=vpn/config/ca.json \
  -profile="server" \
  -hostname="server" \
  vpn/config/csr.json | \
    cfssljson -bare vpn/certs/server
</pre>

<p class="measure copy lh-copy">
Now we can generate certificates for the client. The process is identical to above for the server certificate, only substituting in "client" where appropriate to use the different signing profile. Modify the value of CLIENT_NAME as necessary.
</p>

<pre class="measure copy lh-copy overflow-auto code pa2 bg-near-white black">
export CLIENT_NAME="client1"
cfssl gencert -ca vpn/certs/ca.pem \
  -ca-key vpn/certs/ca-key.pem \
  -config=vpn/config/ca.json \
  -profile="client" \
  -hostname="${CLIENT_NAME}" \
  vpn/config/csr.json | \
    cfssljson -bare "vpn/certs/${CLIENT_NAME}"
</pre>

<p class="measure copy lh-copy">
You should now have the following files for copying to the server: <code class="code bg-near-white pa1">ca.pem</code>, <code class="code bg-near-white pa1">server.pem</code> and <code class="code bg-near-white pa1">server-key.pem</code>, and <code class="code bg-near-white pa1">ca.pem</code>, <code class="code bg-near-white pa1">client1.pem</code> and <code class="code bg-near-white pa1">client1-key.pem</code> for copying to the client.
</p>

<p class="measure copy lh-copy">
Happy VPNing!
</p>


          </div>
        </div>
      </article>
    </main>
        <footer class="bt b--black-10 black-70 pt5">
      <div class="mw9 center ph7-l">
        <a class="link hover-orange near-black dib h2 w2 mr3" href="https://soundcloud.com/derraj" title="SoundCloud">
          <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><g fill-rule="nonzero"><path d="M.773 8.13c-.034 0-.062.03-.067.066L.55 9.633l.156 1.405c.005.038.033.065.067.065.033 0 .06-.027.066-.065l.178-1.405-.18-1.437C.835 8.158.807 8.13.774 8.13M.18 8.682c-.032 0-.06.025-.063.062L0 9.634l.117.872c.004.037.03.063.064.063s.06-.027.065-.063l.14-.874-.14-.89c-.005-.036-.03-.06-.064-.06M1.4 7.85c-.04 0-.075.033-.08.078l-.148 1.705.15 1.643c.003.045.037.078.08.078.04 0 .074-.033.08-.078l.17-1.643-.17-1.705c-.006-.045-.04-.078-.08-.078M2.035 7.79c-.05 0-.09.04-.094.092l-.14 1.75.14 1.696c.005.052.045.092.095.092s.09-.04.094-.092l.16-1.695-.16-1.752c-.006-.05-.046-.09-.095-.09M2.78 11.342zM2.78 8.008c-.003-.06-.05-.106-.106-.106-.058 0-.104.046-.108.107l-.133 1.623.133 1.71c.004.06.05.105.108.105.057 0 .103-.046.107-.106l.152-1.71-.15-1.624zM3.318 6.87c-.065 0-.118.053-.12.12L3.07 9.634l.125 1.71c.003.065.056.118.12.118.065 0 .118-.053.122-.12l.14-1.708-.14-2.644c-.005-.067-.058-.12-.122-.12M3.957 6.262c-.072 0-.132.058-.135.133l-.117 3.248.117 1.698c.003.076.063.134.135.134.072 0 .13-.058.135-.133v.002l.132-1.7-.132-3.247c-.004-.075-.063-.133-.135-.133M4.62 5.968c-.08 0-.144.065-.147.148l-.11 3.52.11 1.68c.003.08.068.146.148.146.08 0 .146-.065.15-.147l.123-1.68-.123-3.52c-.004-.082-.07-.147-.15-.147M5.443 5.997c-.003-.09-.074-.16-.162-.16-.088 0-.16.07-.16.16l-.102 3.638.1 1.67c.003.09.074.16.163.16.09 0 .16-.07.163-.16l.113-1.67-.113-3.638zM5.443 11.304zM5.945 5.915c-.096 0-.173.077-.175.175l-.093 3.545.093 1.654c.002.096.08.173.175.173.096 0 .174-.077.176-.175v.002l.105-1.655L6.12 6.09c0-.098-.08-.175-.175-.175M6.615 6.03c-.104 0-.187.084-.19.19l-.084 3.416.086 1.643c.002.104.085.186.19.186.103 0 .186-.082.19-.188l.093-1.642-.095-3.416c-.003-.106-.086-.19-.19-.19M7.402 5.403c-.032-.02-.07-.034-.112-.034-.04 0-.078.01-.11.032-.054.036-.092.098-.093.17v.038L7.01 9.635l.077 1.634v.006c.003.045.02.087.048.12.037.045.093.074.155.074.055 0 .106-.023.142-.06.037-.036.06-.087.06-.142l.01-.162.077-1.47-.087-4.065c0-.07-.037-.13-.09-.167M7.493 11.27v-.002zM8.072 5.018c-.032-.02-.07-.03-.11-.03-.05 0-.1.017-.137.048-.048.04-.08.1-.08.167v.022l-.09 4.41.047.817.043.793c.002.118.1.215.217.215.118 0 .215-.097.217-.216v.002l.095-1.61-.096-4.433c-.002-.08-.045-.147-.108-.185M14.032 7.538c-.27 0-.527.055-.76.153-.158-1.773-1.645-3.164-3.46-3.164-.443 0-.876.087-1.258.235-.15.06-.188.117-.19.232v6.246c.002.12.095.215.213.226h5.455c1.087 0 1.968-.87 1.968-1.958 0-1.087-.88-1.968-1.968-1.968"/></svg>
        </a>
        <a class="link hover-blue near-black dib h2 w2 mr3" href="https://twitter.com/aeriff" title="Twitter">
          <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.375-1.337.648-2.085.795-.598-.638-1.45-1.036-2.396-1.036-1.812 0-3.282 1.468-3.282 3.28 0 .258.03.51.085.75C5.152 5.39 2.733 4.084 1.114 2.1.83 2.583.67 3.147.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.416-.02-.617-.058.418 1.304 1.63 2.253 3.067 2.28-1.124.88-2.54 1.404-4.077 1.404-.265 0-.526-.015-.783-.045 1.453.93 3.178 1.474 5.032 1.474 6.038 0 9.34-5 9.34-9.338 0-.143-.004-.284-.01-.425.64-.463 1.198-1.04 1.638-1.7z" fill-rule="nonzero"/></svg>
        </a>
      </div>
    </footer>

  </body>
</html>

