<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Managing OpenVPN certificates with cfssl | txt.jarred.eu</title>
    <link rel="stylesheet" href="/static/style.css">
    <meta name="generator" content="Nanoc 4.9.1">
  </head>
  <body class="article">
    <div class="container">

<div class="post">
  <h1>Managing OpenVPN certificates with cfssl</h1>
  <p>I run an instance of OpenVPN for use when I’m out and about on public WiFi, eg. at cafes or airports. Until recently, it ran on a small VPS with Arch Linux x86. Given the deprecation of the x86 architecture by Arch and that I don’t run anything of much value there, I decided to give <a href="http://voidlinux.eu">Void Linux</a> a spin (mostly because I really like <a href="http://smarden.org/runit/">runit</a>, which is the init system in Void). As Void uses libressl which is <a href="https://github.com/OpenVPN/easy-rsa/issues/76">known to not play nicely with easy-rsa</a>, I decided to try managing the CA and client certificates with <a href="https://github.com/cloudflare/cfssl">cfssl</a>.</p>

<p><strong>As a leading caveat:</strong> Proper security around key handling is an exercise left to the reader, this is merely a guide to be able to replace the basic functionality of <code>easy-rsa</code> with <code>cfssl</code>. Operations other than issuing keys are also left up to the reader.</p>

<p>As cfssl expects JSON files for configuration, we’ll take care of that first (modify as needed, eg. common names and country/organisation values):</p>

<div class="language-bash highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>mkdir -p vpn/{config,certs}
cat &gt;vpn/config/csr.json &lt;&lt;CSR
{
    &quot;cn&quot;: &quot;My VPN CA&quot;,
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;DE&quot;,
            &quot;O&quot;: &quot;OpenVPN&quot;
        }
    ]
}
CSR
cat &gt;vpn/config/ca.json &lt;&lt;CA
{
    &quot;signing&quot;: {
        &quot;profiles&quot;: {
            &quot;server&quot;: {
                &quot;expiry&quot;: &quot;43800h&quot;,
                &quot;usages&quot;: [
                    &quot;digital signature&quot;,
                    &quot;key encipherment&quot;,
                    &quot;server auth&quot;
                ]
            },
            &quot;client&quot;: {
                &quot;expiry&quot;: &quot;43800h&quot;,
                &quot;usages&quot;: [
                    &quot;signing&quot;,
                    &quot;client auth&quot;
                ]
            }
        }
    }
}
CA
</pre></div>
</div>
</div>

<p>You’ll notice we’re using TLS key usage extensions as outlined in <a href="https://www.ietf.org/rfc/rfc3280.txt">RFC3280</a> to take advantage of things like the OpenVPN client directive <code>remote-cert-tls server</code>.</p>

<p>Now we can initialise the CA and generate certificates for the server:</p>

<div class="language-bash highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>cfssl genkey -initca vpn/config/csr.json | \
  cfssljson -bare vpn/certs/ca

cfssl gencert -ca=vpn/certs/ca.pem \
  -ca-key=vpn/certs/ca-key.pem \
  -config=vpn/config/ca.json \
  -profile=&quot;server&quot; \
  -hostname=&quot;server&quot; \
  vpn/config/csr.json | \
    cfssljson -bare vpn/certs/server
</pre></div>
</div>
</div>

<p>Now we can generate certificates for the client. The process is identical to above for the server certificate, only substituting in “client” where appropriate to use the different signing profile. Modify the value of <code>CLIENT_NAME</code> as necessary.</p>

<div class="language-bash highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>export CLIENT_NAME=&quot;client1&quot;
cfssl gencert -ca=vpn/certs/ca.pem \
  -ca-key=vpn/certs/ca-key.pem \
  -config=vpn/config/ca.json \
  -profile=&quot;client&quot; \
  -hostname=&quot;${CLIENT_NAME}&quot; \
  vpn/config/csr.json | \
    cfssljson -bare &quot;vpn/certs/${CLIENT_NAME}&quot;
</pre></div>
</div>
</div>

<p>You should now have the following files for copying to the server: <code>ca.pem</code>, <code>server.pem</code> and <code>server-key.pem</code>; and <code>ca.pem</code>, <code>client1.pem</code> and <code>client1-key.pem</code> for copying to the client.</p>

<p>Happy VPNing!</p>

</div>

    </div>
<footer class="footer">
<div class="container">
<a href="/">Home</a> /
<a href="/about">About</a>
</div>
</footer>

  </body>
</html>

